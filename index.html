<!DOCTYPE html>
<html lang="en">
<head>
    <title>Molybdenum</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <link rel="stylesheet" type="text/css" href="media/css/restdown.css">
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
</head>
<body>
<div id="header">
    <h1>Molybdenum Documentation</h1>
</div>

    <div id="sidebar">
<ul>
  <li><div><a href="#html-endpoints">HTML Endpoints</a></div>
  <ul>
    <li><div><a href="#GET-/:repo"><span class="method justendpoint"><span class="endpoint"><span class="verb">GET</span> <span class="path">/:repo</span></span></a></div></li>
    <li><div><a href="#GET-/:repo/tree/:ref/:path"><span class="method justendpoint"><span class="endpoint"><span class="verb">GET</span> <span class="path">/:repo/tree/:ref/:path</span></span></a></div></li>
    <li><div><a href="#GET-/:repo/blob/:ref/:path"><span class="method justendpoint"><span class="endpoint"><span class="verb">GET</span> <span class="path">/:repo/blob/:ref/:path</span></span></a></div></li>
    <li><div><a href="#GET-/:repo/raw/:ref/:path"><span class="method justendpoint"><span class="endpoint"><span class="verb">GET</span> <span class="path">/:repo/raw/:ref/:path</span></span></a></div></li>
    <li><div><a href="#GET-/:repo/commit/:id"><span class="method justendpoint"><span class="endpoint"><span class="verb">GET</span> <span class="path">/:repo/commit/:id</span></span></a></div></li>
    <li><div><a href="#GET-/:repo/commits/:ref"><span class="method justendpoint"><span class="endpoint"><span class="verb">GET</span> <span class="path">/:repo/commits/:ref</span></span></a></div></li>
  </ul></li>
  <li><div><a href="#repository-api">Repository API</a></div>
  <ul>
    <li><div><a href="#GET-/api/repos"><span class="method justendpoint"><span class="endpoint"><span class="verb">GET</span> <span class="path">/api/repos</span></span></a></div></li>
    <li><div><a href="#POST-/api/repos"><span class="method justendpoint"><span class="endpoint"><span class="verb">POST</span> <span class="path">/api/repos</span></span></a></div></li>
    <li><div><a href="#GET-/api/repos/:repo"><span class="method justendpoint"><span class="endpoint"><span class="verb">GET</span> <span class="path">/api/repos/:repo</span></span></a></div></li>
    <li><div><a href="#DELETE-/api/repos/:repo"><span class="method justendpoint"><span class="endpoint"><span class="verb">DELETE</span> <span class="path">/api/repos/:repo</span></span></a></div></li>
    <li><div><a href="#GET-/api/repos/:repo/commits/:branch"><span class="method justendpoint"><span class="endpoint"><span class="verb">GET</span> <span class="path">/api/repos/:repo/commits/:branch</span></span></a></div></li>
    <li><div><a href="#GET-/api/repos/:repo/commit/:commitish-or-ref"><span class="method justendpoint"><span class="endpoint"><span class="verb">GET</span> <span class="path">/api/repos/:repo/commit/:commitish-or-ref</span></span></a></div></li>
    <li><div><a href="#GET-/api/repos/:repo/refs"><span class="method justendpoint"><span class="endpoint"><span class="verb">GET</span> <span class="path">/api/repos/:repo/refs</span></span></a></div></li>
    <li><div><a href="#GET-/api/repos/:repo/refs/:ref[/:path]"><span class="method justendpoint"><span class="endpoint"><span class="verb">GET</span> <span class="path">/api/repos/:repo/refs/:ref[/:path]</span></span></a></div></li>
    <li><div><a href="#GET-/api/commit/:id"><span class="method justendpoint"><span class="endpoint"><span class="verb">GET</span> <span class="path">/api/commit/:id</span></span></a></div></li>
  </ul></li>
  <li><div><a href="#miscellaneous-api">Miscellaneous API</a></div>
  <ul>
    <li><div><a href="#GET-/api"><span class="method justendpoint"><span class="endpoint"><span class="verb">GET</span> <span class="path">/api</span></span></a></div></li>
  </ul></li>
  <li><div><a href="#configuration">Configuration</a></div></li>
  <li><div><a href="#post-fetch-hooks">Post-Fetch Hooks</a></div>
  <ul>
    <li><div><a href="#Jira"><span class="method name"><span class="name">Jira built-in post-fetch hook</span></span></a></div></li>
  </ul></li>
</ul>

    </div>
    <div id="content">

<h1>Molybdenum</h1>
<div class="intro">


<p>A github tree viewer when your repo isn't on Github (or even if it is).
This project lives <a href="https://github.com/trentm/molybdenum">here on GitHub</a>.</p>

<p><img src="media/img/screenshot.png" alt="molybdenum screenshot" /></p>

<p>This is a node.js server that provides a web-browsable view of your git
repos and a JSON REST API. Basically, you setup post-receive hooks for
notifying Molybdenum of your repo pushes and that's it.</p>

<p>Currently basic repo browsing (somewhat Github-esque) is supported and
integration with Jira for adding ticket comments for pushes referencing
Jira tickets.</p>

<p>We're using this internally at Joyent.</p>

<p><strong>WARNING: Unfortunately, right <em>now</em> I don't have bandwidth to support this well
for others. I'm scratching a personal itch here, and a significant chunk of
hacking and duct tape is involved. Also, this is significantly under-documented.</strong></p>


</div>
<h1 id="html-endpoints">HTML Endpoints</h1>

<p>TODO: document and name these</p>

<h2 id="GET-/:repo"><span class="method justendpoint"><span class="endpoint"><span class="verb">GET</span> <span class="path">/:repo</span></span></h2>

<h2 id="GET-/:repo/tree/:ref/:path"><span class="method justendpoint"><span class="endpoint"><span class="verb">GET</span> <span class="path">/:repo/tree/:ref/:path</span></span></h2>

<h2 id="GET-/:repo/blob/:ref/:path"><span class="method justendpoint"><span class="endpoint"><span class="verb">GET</span> <span class="path">/:repo/blob/:ref/:path</span></span></h2>

<h2 id="GET-/:repo/raw/:ref/:path"><span class="method justendpoint"><span class="endpoint"><span class="verb">GET</span> <span class="path">/:repo/raw/:ref/:path</span></span></h2>

<h2 id="GET-/:repo/commit/:id"><span class="method justendpoint"><span class="endpoint"><span class="verb">GET</span> <span class="path">/:repo/commit/:id</span></span></h2>

<h2 id="GET-/:repo/commits/:ref"><span class="method justendpoint"><span class="endpoint"><span class="verb">GET</span> <span class="path">/:repo/commits/:ref</span></span></h2>

<h1 id="repository-api">Repository API</h1>

<h2 id="GET-/api/repos"><span class="method justendpoint"><span class="endpoint"><span class="verb">GET</span> <span class="path">/api/repos</span></span></h2>

<p>List all repositories currently in the molybdenum server.</p>

<h4>example request</h4>

<pre class="shell"><code>curl {{ url }}/api/repos
</code></pre>

<h4>example response</h4>

<pre><code>{
  "repositories": [
    {
      "name": "eol",
      "url": "https://github.com/trentm/eol.git",
      "dir": "/data/molybdenum/repos/eol.git",
      // Note: The following are internal. Will probably be removed.
      "isCloned": true,
      "isFetchPending": false,
      "numActiveFetches": 0,
      ...
    }
  ]
}
</code></pre>

<h2 id="POST-/api/repos"><span class="method justendpoint"><span class="endpoint"><span class="verb">POST</span> <span class="path">/api/repos</span></span></h2>

<p>Let the server know about a new push to a repo. The request body must be a JSON
object of the following form (compatible with the Github URL post-receive
hook JSON format <a href="http://help.github.com/post-receive-hooks/">http://help.github.com/post-receive-hooks/</a>):</p>

<pre><code>{
  "repository": {
    "url": $git_clone_url,
    "name": $name
  }
}
</code></pre>

<h4>example request</h4>

<pre class="shell"><code>echo '{
    "repository": {
        "url": "git@code.example.com:cool-product.git",
        "name": "cool-product"
    }
}' | curl {{ url }}/api/repos -X POST -H "Content-Type: application/json" -d @-
</code></pre>

<h4>successful response</h4>

<pre><code>...
Status: 200

{
  "repository": {
    "name": "cool-product",
    "url": "git@code.example.com:cool-product.git",
    "isCloned": false,
    "isFetchPending": true
  }
}
</code></pre>

<h2 id="GET-/api/repos/:repo"><span class="method justendpoint"><span class="endpoint"><span class="verb">GET</span> <span class="path">/api/repos/:repo</span></span></h2>

<p>Return info on all current repositories in the molybdenum server.</p>

<h4>example request</h4>

<pre class="shell"><code>curl {{ url }}/api/repos/eol
</code></pre>

<h4>example response</h4>

<pre><code>{
  "repository": {
    "name": "eol",
    "url": "https://github.com/trentm/eol.git",
    "dir": "/data/molybdenum/repos/eol.git",
    ...
  }
}
</code></pre>

<h4>failure response</h4>

<pre><code>...
Status: 404

{
  "error": {
    "message": "no such repo: 'asdf'",
    "code": 404
  }
}
</code></pre>

<h2 id="DELETE-/api/repos/:repo"><span class="method justendpoint"><span class="endpoint"><span class="verb">DELETE</span> <span class="path">/api/repos/:repo</span></span></h2>

<h2 id="GET-/api/repos/:repo/commits/:branch"><span class="method justendpoint"><span class="endpoint"><span class="verb">GET</span> <span class="path">/api/repos/:repo/commits/:branch</span></span></h2>

<h3>options</h3>

<table>
<tbody>
<tr><td>limit</td><td>Integer</td></tr>
<tr><td>offset</td><td>Integer</td></tr>
</tbody>
</table>

<h2 id="GET-/api/repos/:repo/commit/:commitish-or-ref"><span class="method justendpoint"><span class="endpoint"><span class="verb">GET</span> <span class="path">/api/repos/:repo/commit/:commitish-or-ref</span></span></h2>

<h2 id="GET-/api/repos/:repo/refs"><span class="method justendpoint"><span class="endpoint"><span class="verb">GET</span> <span class="path">/api/repos/:repo/refs</span></span></h2>

<h2 id="GET-/api/repos/:repo/refs/:ref[/:path]"><span class="method justendpoint"><span class="endpoint"><span class="verb">GET</span> <span class="path">/api/repos/:repo/refs/:ref[/:path]</span></span></h2>

<h2 id="GET-/api/commit/:id"><span class="method justendpoint"><span class="endpoint"><span class="verb">GET</span> <span class="path">/api/commit/:id</span></span></h2>

<pre><code>{
  "commit": {
    "id": "50c3c7295d473e42adaf14f4e6f12df5c18a6e01",
    "message": "slight adding to Tim's test case for html5 block tags\n",
    "author": {
      "name": "Trent Mick",
      "email": "trentm@gmail.com",
      "time": "2011-03-23T04:48:40.000Z",
      "timeOffset": -420
    },
    "committer": {
      "name": "Trent Mick",
      "email": "trentm@gmail.com",
      "time": "2011-03-23T04:48:40.000Z",
      "timeOffset": -420
    },
    "parents": [
      "b72fee60f3c25e70d349567578f01011c450b5a5"
    ],
    "tree": "16c95e7f8d2006871c34d9e8e716b4d0048eb165"
  },
  "repository": {
    "name": "markdown2",
    "url": "git@github.com:trentm/python-markdown2.git",
    "isCloned": true,
    "isFetchPending": false
  }
}
</code></pre>

<h1 id="miscellaneous-api">Miscellaneous API</h1>

<h2 id="GET-/api"><span class="method justendpoint"><span class="endpoint"><span class="verb">GET</span> <span class="path">/api</span></span></h2>

<p>Return this HTML documentation or a JSON representation of the API, depending
on the request "Accept" header.</p>

<h4>example JSON response</h4>

<pre><code>{
  "endpoints": [
    ...
  ],
  "version": "1.0.0"
}
</code></pre>

<h1 id="configuration">Configuration</h1>

<p>A Molybdenum server (node app.js) always loads a default config (at
INSTALLDIR/default-config/molybdenum.json) and optionally a given
configuration JSON file passed in via the <code>-c|--config PATH</code> command-line
switch or via the <code>MOLYBDENUM_CONFIG</code> envvar.</p>

<table>
<tbody>
<tr><td><strong>name</strong></td><td><strong>type</strong></td><td><strong>description</strong></td></tr>
<tr><td>name</td><td>string</td><td>Name of this instance. Used in the UI. Default "Molybdenum".</td></tr>
<tr><td></td></tr>
<tr><td>protocol</td><td>string</td><td>"http" or "https". Default "http".</td></tr>
<tr><td>host</td><td>string</td><td>Host IP on which to listen. Default "127.0.0.1".</td></tr>
<tr><td>port</td><td>string</td><td>Port on which to listen. Default "3333".</td></tr>
<tr><td>httpRedirect</td><td>string</td><td>Optionally set 'httpRedirect' to a URL to which to redirect any requests to http port 80. This will only run when the primary server is configured to run on https port 443. The idea is to provide a nice redirect from, say, "http://mo.example.com/*" to "https://mo.example.com/" for the first time user not having to explicitly remember the "https://" prefix in their browser.</td></tr>
<tr><td></td></tr>
<tr><td>dataDir</td><td>string</td><td>Dir in which to store all repo data. Relative path to the current working dir.</td></tr>
<tr><td>pidFile</td><td>string</td><td>Optional. Can be set to create a PID file. Path is relative to the cwd when started.</td></tr>
<tr><td></td></tr>
<tr><td>adminName</td><td>string</td><td>Administrator name used in admin error emails. Also see <code>authAdminName</code> below. Default "Your Molybdenum Administrator".</td></tr>
<tr><td>adminEmail</td><td>string</td><td>Optional. Administrator email address to use for admin error emails.</td></tr>
<tr><td></td></tr>
<tr><td>authMethod</td><td>string</td><td>One of "public" (everything is public, no authentication is done), "static" (uses static JSON describing all user credentials, should only use this for testing), "ldap" (uses LDAP authentication), "sdccapi" (uses a Joyent SmartDataCenter CAPI). See related "auth${Name}*" variables for each method.</td></tr>
<tr><td>authPublicAnonymousUser</td><td>object</td><td>JSON to be return as the fallback user for all auth'd endpoints. Default is <code>{"login": "guest"}</code>. If this setting is empty or not given, Molybdenum will attempt to get user info from the "X-Authorized-User" header (e.g. set by upstream proxy, expected to be JSON).</td></tr>
<tr><td>authStaticFile</td><td>string</td><td>Path (relative to this config file) to JSON file that looks like: <code>[{"login": "guest", "password": "guest", "uuid": "4159832a-a5cd-1848-93cd-3cd89fa97000"}, ...]</code></td></tr>
<tr><td>authLdapUrl</td><td>string</td><td>The LDAP URL to which to bind. E.g. "ldaps://ldap.example.com:636". Note: LDAP over SSL is supported, but not TLS (see <a href="http://ldapjs.org/client.html">http://ldapjs.org/client.html</a>)</td></tr>
<tr><td>authLdapAdminDn</td><td>string</td><td>The Admin DN.</td></tr>
<tr><td>authLdapAdminPassword</td><td>string</td><td>The Admin DN's password.</td></tr>
<tr><td>authLdapSearchBase</td><td>string</td><td>The base DN to search for users/accounts.</td></tr>
<tr><td>authLdapSearchFilter</td><td>string</td><td>E.g. '(uid={{username}})'</td></tr>
<tr><td>authLdapUsernameField</td><td>string</td><td>LDAP record field used for the username/login. Optional.</td></tr>
<tr><td>authSdccapiClientUrl</td><td>string</td><td></td></tr>
<tr><td>authSdccapiHttpAdminUser</td><td>string</td><td></td></tr>
<tr><td>authSdccapiHttpAdminPassword</td><td>string</td><td></td></tr>
<tr><td>authAuthorizedUsers</td><td>array</td><td>An list of authenticated users to which to allow access. Each "user" can be a username/login string or a uuid. If not specified or empty then all authenticated users are allowed access.</td></tr>
<tr><td></td></tr>
<tr><td>navLinks</td><td>array</td><td>List of links to place in the top-right Molybdenum nav bar. Each array element is <code>{"name": &lt;link name&gt;, "href": &lt;link url&gt;}</code>. E.g.: <code>{"name": "Bugs", "href": "https://issues.example.com"}</code>. You can use <code>{{navLinksRepo}}</code> in these values for the repo name on repo pages.</td></tr>
<tr><td>searchForm</td><td>object</td><td>You can add a search form to the top-right navbar of Molybdenum pages. E.g. <code>{"name": "OpenGrok", "href": "/source", "q": "q", "hidden": {"project": "{{searchFormRepo}}"}}</code>. "name" (required) is placeholder text. "href" (required) is the URL at which to search. "q" is the query param name for the search (i.e. the search text field name). "hidden" is a list of hidden form fields: e.g. <code>[{"name": "project", "value": "{{searchFormRepo}}"}]</code> The hidden "value" can be the special "{{searchFormRepo}}" template var which evaluates to the name of the repo for the current page (e.g. "eol" on the "/eol/tree/master" page).</td></tr>
<tr><td></td></tr>
<tr><td>postFetchHooks</td><td>array</td><td>Array of post-fetch hooks. These are either a hook name (for built-in hooks that ship with Molybdenum) or the full path to a separately installed post-fetch hook. For example: <code>["jira", "/home/mo/hooks/my-custom-post-fetch-hook"]</code>. See 'Post-Fetch Hooks' below.</td></tr>
</tbody>
</table>

<h1 id="post-fetch-hooks">Post-Fetch Hooks</h1>

<p>Molybdenum supports a list of hooks to run for each repo fetch (see
"postFetchHooks" config var above.) These are either a built-in hook -- i.e.
that ships with Molybdenum -- or the full path to a separately installed
post-fetch hook script. The built-in hooks are all at
"tools/${NAME}-post-fetch-hook".</p>

<p>Each post-fetch hook is called for each branch/revision-range fetched
whenever a repo is updated. They are called with the same signature as
a regular git post-receive hook:</p>

<pre><code>.../foo-post-fetch-hook OLDREV NEWREV REFNAME
</code></pre>

<p>with the addition that the "MOLYBDENUM_CONFIG" and "CONFIG" envvars are
set to the full path to the Molybdenum ini config file. This allows a
post-fetch script to get configuration info. For example:</p>

<pre><code>CONFIG=/home/mo/config/molybdenum.ini \
    MOLYBDENUM_CONFIG=/home/mo/config/molybdenum.ini \
    /home/mo/hooks/my-custom-post-fetch-hook ea8d8c5 8d83628 refs/heads/master
</code></pre>

<p>By convention a post-fetch hook needing config info should use a
<code>${name}PostFetchHook</code> section in the JSON config file. E.g.:</p>

<pre><code>{
  ...
  "postFetchHooks": "/home/mo/hooks/my-custom-post-fetch-hook",
  "myCustomPostFetchHook": {
    "foo": "bar",
    ...
  },
  ...
}
</code></pre>

<h2 id="Jira"><span class="method name"><span class="name">Jira built-in post-fetch hook</span></span></h2>

<p>This is a post-fetch hook to add a comment describing a commit to a Jira
ticket if that ticket id (e.g. "PROJECTA-42") is mentioned in the commit
message.</p>

<p>An example configuration block:</p>

<pre><code>"jiraPostFetchHook": {
    // Required fields.
    "moUrl": "https://mo.example.com",
    "jiraUrl": "https://jira.example.com",
    "jiraCredentials": "BOTACCOUNT:BOTPASSWORD",
    "jiraProjects": ["PROJECTA", "PROJECTB"],

    // Optional fields.

    // If true, just go through motions without actually adding Jira comments.
    "dryRun": true                  // Default: false.
    "git": "/opt/local/bin/git",    // Default: `git` from PATH.
    "admin": "Trent"                // Default: `adminName` from top-level config.

    // DEPRECATED. Will be removed. Use the whitelist/blacklist below.
    //
    // A boolean that tells the hook to NOT process commits to branches
    // that are named after a ticket. E.g. "PROJECTA-123". The idea here
    // is that these are very likely short-lived feature brances that
    // will be merged into a mainstream branch when complete.
    "ignoreTicketBranches": true    // Default: false.

    // A whitelist/blacklist for controlling which branches this hook
    // will ignore.
    // - both empty: process all  (the default)
    // - whitelist = ['*/master'], blacklist = []: only master branches
    //   in all repos
    // - whitelist = ['*/master', '*/release-*', 'public-web-client/jpc'],
    //   blacklist = ['blarg/release-*']: all master branches, all
    //   'release-*' branches except for 'blarg' repo, the 'jpc' branch
    //   in the 'public-web-client' repo
    "branchWhitelist": [],
    "branchBlacklist": [],
}
</code></pre>

    </div>
<script type="text/javascript" charset="utf-8">
$(function() {
    var headerHeight = $("#header").height();

    var sections = $("#content h1[id], #content h2[id]");
    var sectionOffsets = [];
    var slack = 100;  // Give the section scroll some slack (in pixels).
    sections.each(function(elem) {
        sectionOffsets.push($(this).offset().top - headerHeight - slack);
    });

    var currSectionIdx = -1;
    function getSectionIdx(scrollDistance) {
        if (scrollDistance < sectionOffsets[0]) {
            return -1;
        } else {
            for (var id = sectionOffsets.length; id > 0; id--) {
                if (scrollDistance > sectionOffsets[id - 1]) {
                    return id - 1;
                    break;
                }
            }
        }
    }

    /** {{{ http://code.activestate.com/recipes/577787/ (r2) */
    _slugify_strip_re = /[^\w\s-]/g;
    _slugify_hyphenate_re = /[-\s]+/g;
    function slugify(s) {
      s = s.replace(_slugify_strip_re, '').trim().toLowerCase();
      s = s.replace(_slugify_hyphenate_re, '-');
      return s;
    }
    /** end of http://code.activestate.com/recipes/577787/ }}} */

    /* See <https://github.com/trentm/restdown/issues/11>. */
    function safechars(s) {
      return s.replace(_slugify_strip_re, '');
    }

    $("#content").scroll(function() {
        var scrollDistance = $("#content").scrollTop();
        var sectionIdx = getSectionIdx(scrollDistance);

        if (sectionIdx !== currSectionIdx) {
            $("#sidebar li>div").removeClass("current");
            currSectionIdx = sectionIdx;
            if (currSectionIdx >= 0) {
                var heading = $(sections[currSectionIdx]).text();
                var possibleAnchors = [
                    slugify(heading), // h1 or non-method h2
                    heading.replace(/ /g, '-'), // h2 method, just name or just endpoint
                    heading.slice(0, heading.lastIndexOf(' (')).trimRight().replace(/ /g, '-'), // h2 method, name and endpoint
                ];
                for (var i=0; i < possibleAnchors.length; i++) {
                    var anchor = safechars(possibleAnchors[i]);
                    try {
                        $("#sidebar a[href=#" + anchor + "]").parent().addClass("current");
                    } catch (e) {
                        /* Ignore error if no such element. */
                        console.log(e)
                    }
                }
            }
        }
    });
});
</script>

</body>
</html>
